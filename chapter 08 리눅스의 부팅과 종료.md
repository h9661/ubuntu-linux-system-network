# 01 리눅스 시스템의 부팅

리눅스의 부팅 과정은 다음과 같다.

![](https://velog.velcdn.com/images/qorgus31/post/3ffde13e-780d-417b-a461-33095459ed07/image.png)

## 1.1 바이오스 단계

피시를 켜면 바이오스가 동작한다. 바이오스는 ROM에 저장되어 있어서 ROM BIOS라고 부르기도 한다. 바이오스는 컴퓨터의 하드웨어의 상태를 확인한 후 부팅 장치를 선택하여 부딩 디스크 첫 섹터에서 512B를 로딩한다. 이 512B를 마스터 부트 레코드라고 한다. 로딩된 MBR은 부트 로더를 찾아서 메모리에 로딩한다.

## 1.2 부트 로더 단계

부트 로더는 여러 운영체제 중에서 부팅할 운영체제를 선택할 수 있도록 메뉴를 제공한다. 부트 로더는 커널을 메모리에 로딩하고 커널의 실행을 시작한다.

## 1.3 커널 초기화 단계

커널은 컴퓨터의 하드웨어를 초기화하고 루트 파일 시스템을 마운트한다. 그리고 systemd 프로세스를 실행한다.

## 1.4 systemd 서비스 단계

## 1.5 로그인 프롬프트 출력

# 02 systemd 서비스

다양한 서비스 데몬을 시작하고, 프로세스들의 상태를 유지하며 시스템의 상태를 관리하는 프로세스이다.

## 2.1 init 프로세스

init 프로세스는 스크립트를 순차적으로 실행하여 다른 프로세스를 동작시켰다.

## 2.2 init 프로세스 런레벨

init 프로세스는 없어졌지만, init 프로세스에서 사용하던 런레벨의 개념은 이해해야 한다. 런레벨은 지금도 사용하고 있기 때문이다. init은 시스템을 일곱 단계로 정의하여 구분하고, 각 단계에 따라 셸 스크립트를 실행하는데, 이러한 단계를 런레벨이라고 한다. 런레벨은 다음의 표와 같다.

| 런레벨 | 설명                      | 관련 스크립트의 위치   |
| ------ | ------------------------- | ---------------------- |
| 0      | 시스템 종료               | /etc/rc0.d             |
| 1, S   | 응급 복구 모드            | /etc/rc1.d, /etc/rcS.d |
| 2      | 다중 사용자 모드          | /etc/rc2.d             |
| 3      | 다중 사용자 모드          | /etc/rc3.d             |
| 4      | 다중 사용자 모드          | /etc/rc4.d             |
| 5      | 그래피컬 다중 사용자 모드 | /etc/rc5.d             |
| 6      | 시스템 재부팅             | /etc/rc6.d             |

## 2.3 systemd의 기본 개념

systemd는 리눅스 서비스 관리와 관련하여 매우 복잡한 구조를 가지고 있기에 자세한 것은 다른 책을 참고하자. 여기서는 기본적인 개념을 이해하고 명령어 사용법만 볼 것이다.

우분투는 특정 버전부터 systemd를 기본 서비스 관리자로 사용하고 있다. systemd는 init 방식에 비해 다음과 같은 장점을 가지고 있다.

- 소켓 기반 동작하여 inetd와 호환성을 유지
- 셸과 독립적 부팅 가능
- 마운트 제어 가능
- 시스템 상태에 대한 스냅샷 유지
- 서비스에 시그널 전달 가능
- 등등...

### systemd 유닛

systemd는 서비스를 유닛이라는 단위로 관리한다. 유닛은 다음과 같은 종류가 있다.

- 서비스 유닛 : 서비스를 관리하는 유닛
- 타이머 유닛 : 특정 시간에 서비스를 실행하는 유닛
- 타겟 유닛 : 다른 유닛을 의존성에 따라 실행하는 유닛
- 장치 유닛 : 하드웨어 장치를 관리하는 유닛
- 마운트 유닛 : 파일 시스템을 마운트하는 유닛
- 스왑 유닛 : 스왑을 관리하는 유닛
- 스코프 유닛 : 프로세스 그룹을 관리하는 유닛
- 소켓 유닛 : 소켓을 관리하는 유닛
- 패스 유닛 : 파일 시스템 경로를 관리하는 유닛
- 슬라이스 유닛 : 프로세스 그룹을 관리하는 유닛

## 2.4 systemd 관련 명령

systemd 기반으로 서비스를 시작하거나 종료할 때 사용하는 명령은 systemctl이다. systemctl 명령은 다음과 같은 형식으로 사용한다.

```bash
systemctl [옵션] [명령] [유닛]
```

### 동작 중인 유닛 출력하기

옵션이나 명령 없이 systemctl 명령을 실행하면 현재 동작 중인 유닛의 목록을 출력한다.

```bash
$ systemctl
```

### 전체 유닛 출력하기 : `-a` 옵션

### 특정 유닛 출력하기 : `-t` 옵션

### 유닛 서비스 시작하기 : `start` 명령

### 유닛 상태 확인하기 : `status` 명령

### 유닛 서비스 중지하기 : `stop` 명령

## 2.5 systemd와 런레벨

### 현재 target과 런레벨 확인하기

현재 target은 다음의 명령으로 확인할 수 있다.

```bash
$ systemctl get-default
```

### 기본 target 지정하기

부팅할 때 동작할 기본 런레벨은 다음의 명령으로 지정할 수 있다.

```bash
$ systemctl set-default [target]
```

이 명령은 `/etc/systemd/system` 디렉터리에 심벌릭 링크인 `default.target`이 가리키는 target 파일을 변경한다.

### target 변경하기

target을 변경하려면 다음의 명령을 사용한다.

```bash
$ systemctl isolate [target]
```

### telinit, init 명령으로 런레벨 변경하기

systemd는 telinit, init 명령을 사용하여 런레벨을 변경할 수 있다.

```bash
$ telinit [target]
$ init [target]
```

### 단일 사용자 모드로 전환하기 : `rescue.target`(런레벨 1)

시스템에 문제가 있을 경우 단일 사용자 모드로 전환하여 문제를 해결할 수 있다. 단일 사용자 모드로 전환하려면 다음의 명령을 사용한다.

```bash
$ systemctl isolate rescue
$ systemctl isolate runlevel1
$ init 1
$ telinit S
```

다시 다중 사용자 모드로 전환하려면 다음의 명령을 사용한다.

```bash
$ systemctl isolate multi-user
$ systemctl isolate runlevel3
$ init 3
$ telinit 3
```

# 03 리눅스 시스템의 종료

## 3.1 shutdown 명령 사용하기

## 런레벨 변경하여 종료하기

## 기타 시스템 종료 명령

# 04 데몬 프로세스

데몬은 백그라운드에서 동작하면서 특정 서비스를 제공하는 프로세스를 의미한다. 리눅스 시스템에서 동작하는 웹 서버나 데이터베이스 서버, 원격 접속 등 각종 서비스를 제공하는 프로세스가 바로 데몬이다.

## 4.1 데몬의 동작 방식

데몬은 독자형 데몬과 슈퍼 데몬에 의해 동작하는 데몬, 2가지로 구분된다. 독자형은 백그라운드에서 항상 동작하고 있는데, 자주 호출되는 데몬이 아니라면 시스템 자원을 낭비할 우려가 있다. 후자의 경우에는 평소에 슈퍼 데몬만 동작하다가 서비스 요청이 오면 슈퍼 데몬이 해당 데몬을 동작시키는 방식이다. 따라서 응답은 전자보다 오래 걸리지만, 자원을 보다 효율적으로 사용한다는 장점이 있다.

## 4.2 슈퍼 데몬

데몬의 종류가 늘어나자 슈퍼 데몬이 등장했다. 우분투에서는 `xinetd`가 슈퍼 데몬으로 사용된다.

## 4.3 데몬의 조상

대부분의 데몬을 동작시키는 조상 데몬이 있다. `systemd`와 커널 스레드 데몬이 바로 그것이다.

### systemd 데몬

앞에서 살펴보았듯, systemd는 init을 대체한 데몬이다. systemd는 1번 프로세스로서 프로세스 대부분의 조상 프로세스이며 시스템의 상태를 종합적으로 관리하는 역할을 수행한다.

### 커널 스레드 데몬

커널의 일부분을 프로세스처럼 관리하는 데몬을 커널 데몬이라고 한다. ps 명령으로 확인했을 때 []에 들어있는 프로세스이다. 커널 데몬은 대부분 입출력이나 메모리 관리, 디스크 동기화 등을 수행하며 낮은 PID를 가지고 있다.

## 4.4 주요 데몬

각종 서비스를 제공하기 위한 주요 데몬은 다음 표와 같다. 이 외에도 매우 다양한 데몬이 존재한다.

| 데몬 이름 | 기능                                |
| --------- | ----------------------------------- |
| crond     | 주기적으로 프로그램을 실행하는 데몬 |
| httpd     | 웹 서버 데몬                        |
| mysqld    | 데이터베이스 서버 데몬              |
| sshd      | 원격 접속을 제공하는 데몬           |
| xinetd    | 슈퍼 데몬                           |
| udevd     | 하드웨어 장치를 관리하는 데몬       |
| systemd   | init을 대체한 데몬                  |
| kthreadd  | 커널 스레드 데몬                    |

# 05 부트 로더

앞서 말했듯, 부트 로더는 커널을 메모리에 올리는 역할을 수행한다. 우분투에서는 기본적으로 GRUB를 지원한다. 이 절에서는 계정의 암호를 잊어버렸을 때 단일 사용자 모드로 부팅하여 암호를 복구하는 과정을 살펴본다. 부트 로더에 관한 자세한 내용은 다른 책을 참고하라.

## 5.1 GRUB의 개요

리눅스의 전통적인 부트로더인 LILO의 단점을 보완하여 GNU 프로젝트의 일환으로 개발되었다. GRUB는 GNU GRand Unified Bootloader의 약자이다. GRUB는 다음과 같은 특징을 가진다.

- LILO는 리눅스에서만 사용이 가능하지만, GRUB는 윈도우에서도 사용할 수 있다.
- LILO에 비해 설정과 사용이 편리하다
- 부팅할 때 명령을 사용하여 수정할 수 있다.
- 멀티 부팅 기능을 지원한다.

우분투는 GRUB2로 최신 버전을 사용한다. 이식성과 모듈화가 더 좋아졌다.

## 5.2 GRUB2 관련 디렉터리와 파일

### /boot/grub/grub.cfg 파일

이 파일의 내용은 수정 불가능하고, 이 파일은 /etc/default/grub와 /etc/grub.d 디렉터리에 있는 파일을 참조하여 생성된다.

### /etc/grub.d 디렉터리

이 디렉터리는 GRUB 스크립트를 가지고 있다. 이 스크립트들은 GRUB의 명령이 실행될 때 순서대로 읽혀 grub.cgf 파일이 생성된다.

### /etc/default/grub 파일

이 파일에는 GRUB 메뉴 설정 내용이 저장되어 있으며 GRUB 스크립트가 이 파일을 읽어서 grub.cfg에 기록한다.

## 5.3 암호 복구하기

GRUB2 부트 로더와 관련된 사용법 중에서 꼭 알아야 하는 것은 단일 모드로 부팅하여 계정의 암호를 복구하는 것이다. 절차는 다음과 같다.

1. 시스템 재시작하기
2. GRUB 편집 모드로 전환하기
3. 단일 사용자 모드로 수정하기
4. 재시작하기
5. 재부팅하기

## 5.4 복구 모드로 부팅하기

어떤 이유로 우분투가 부팅되지 않는다면 복구 모드로 부팅하는 것이 유용할 수 있다. 복구 모드는 가장 기본적인 서비스만 제공하며 명령 모드로 작업할 수 있다. 절차는 다음과 같다.

1. 복구 모드 선택하기
2. root 항목 선택하기
3. root로 로그인하기
4. 다시 마운트하기
5. 재시작하기
